<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AutoClaudeKMP Dashboard</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #1a1a2e;
      color: #eee;
      min-height: 100vh;
      padding: 20px;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 20px;
      border-bottom: 1px solid #333;
    }

    h1 {
      font-size: 24px;
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .status-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #2ecc71;
    }

    .status-dot.warning {
      background: #f1c40f;
    }

    .status-dot.error {
      background: #e74c3c;
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .tab {
      padding: 10px 20px;
      background: #16213e;
      border: none;
      border-radius: 8px;
      color: #888;
      cursor: pointer;
      font-size: 14px;
    }

    .tab.active {
      background: #0f3460;
      color: #fff;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
    }

    .card {
      background: #16213e;
      border-radius: 12px;
      padding: 20px;
    }

    .card.full-width {
      grid-column: 1 / -1;
    }

    .card h2 {
      font-size: 16px;
      color: #888;
      margin-bottom: 15px;
    }

    .stat {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .stat-value {
      font-size: 24px;
      font-weight: bold;
    }

    .stat-value.positive {
      color: #2ecc71;
    }

    .stat-value.negative {
      color: #e74c3c;
    }

    .request-list {
      list-style: none;
    }

    .request-item {
      background: #1a1a2e;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
    }

    .request-title {
      font-weight: bold;
      margin-bottom: 8px;
    }

    .request-description {
      color: #888;
      font-size: 14px;
      margin-bottom: 10px;
    }

    .request-actions {
      display: flex;
      gap: 10px;
    }

    button {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }

    .btn-approve {
      background: #2ecc71;
      color: white;
    }

    .btn-reject {
      background: #e74c3c;
      color: white;
    }

    .btn-primary {
      background: #3498db;
      color: white;
    }

    .btn-secondary {
      background: #555;
      color: white;
    }

    .activity-list {
      list-style: none;
      max-height: 300px;
      overflow-y: auto;
    }

    .activity-item {
      display: flex;
      gap: 10px;
      padding: 10px 0;
      border-bottom: 1px solid #333;
    }

    .activity-time {
      color: #888;
      font-size: 12px;
      min-width: 60px;
    }

    .activity-icon {
      width: 20px;
    }

    .activity-text {
      flex: 1;
      font-size: 14px;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #888;
    }

    /* 提案フォーム */
    .suggestion-form {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .form-group label {
      color: #888;
      font-size: 14px;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      padding: 10px;
      border: 1px solid #333;
      border-radius: 6px;
      background: #1a1a2e;
      color: #eee;
      font-size: 14px;
    }

    .form-group textarea {
      min-height: 100px;
      resize: vertical;
    }

    .form-row {
      display: flex;
      gap: 15px;
    }

    .form-row .form-group {
      flex: 1;
    }

    /* 提案一覧 */
    .suggestion-list {
      list-style: none;
    }

    .suggestion-item {
      background: #1a1a2e;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
    }

    .suggestion-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }

    .suggestion-header-left {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
      min-width: 0;
    }

    .suggestion-header-right {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-shrink: 0;
    }

    .suggestion-title {
      font-weight: bold;
    }

    .suggestion-status {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
    }

    .status-pending { background: #f1c40f; color: #000; }
    .status-reviewing { background: #3498db; color: #fff; }
    .status-accepted { background: #2ecc71; color: #fff; }
    .status-rejected { background: #e74c3c; color: #fff; }
    .status-implemented { background: #9b59b6; color: #fff; }
    .status-deferred { background: #95a5a6; color: #fff; }

    .suggestion-content {
      color: #aaa;
      font-size: 13px;
      margin-bottom: 6px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      line-height: 1.4;
    }

    .suggestion-response {
      background: #0f3460;
      border-radius: 6px;
      padding: 10px;
      margin-top: 10px;
    }

    .suggestion-response h4 {
      color: #3498db;
      font-size: 14px;
      margin-bottom: 8px;
    }

    .suggestion-response p {
      font-size: 14px;
      line-height: 1.5;
    }

    .suggestion-meta {
      display: flex;
      justify-content: flex-end;
      font-size: 11px;
      color: #666;
    }

    /* 提案ステータスタブ（常時表示） */
    .suggestion-status-tabs {
      display: block;
    }

    .kanban-empty {
      text-align: center;
      color: #555;
      font-size: 13px;
      padding: 20px 0;
    }

    .status-tab-buttons {
      display: flex;
      gap: 5px;
      margin-bottom: 15px;
      overflow-x: auto;
      padding-bottom: 5px;
    }

    .status-tab-btn {
      padding: 8px 12px;
      background: #1a1a2e;
      border: none;
      border-radius: 6px;
      color: #888;
      cursor: pointer;
      font-size: 13px;
      white-space: nowrap;
      transition: background 0.2s, color 0.2s;
    }

    .status-tab-btn.active {
      background: #0f3460;
      color: #fff;
    }

    .status-tab-btn .tab-count {
      margin-left: 4px;
      background: #333;
      padding: 1px 6px;
      border-radius: 8px;
      font-size: 11px;
    }

    .status-tab-btn.active .tab-count {
      background: #3498db;
    }

    .status-tab-content {
      display: none;
    }

    .status-tab-content.active {
      display: block;
    }

    /* 提案タブ横並びレイアウト */
    .suggestions-layout {
      display: flex;
      gap: 20px;
    }

    .suggestions-layout .suggestion-form-card {
      flex: 0 0 340px;
      min-width: 340px;
    }

    .suggestions-layout .suggestion-list-card {
      flex: 1;
      min-width: 0;
    }

    .suggestions-layout .suggestion-form {
      gap: 10px;
    }

    .suggestions-layout .form-group textarea {
      min-height: 80px;
    }

    .suggestions-layout .form-row {
      flex-direction: column;
      gap: 10px;
    }

    @media (max-width: 768px) {
      .suggestions-layout {
        flex-direction: column;
      }
      .suggestions-layout .suggestion-form-card {
        flex: none;
        min-width: auto;
      }
    }

    .badge {
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 11px;
    }

    .badge-feature { background: #3498db33; color: #3498db; }
    .badge-bug { background: #e74c3c33; color: #e74c3c; }
    .badge-improvement { background: #2ecc7133; color: #2ecc71; }
    .badge-question { background: #9b59b633; color: #9b59b6; }
    .badge-other { background: #95a5a633; color: #95a5a6; }

    .badge-low { background: #2ecc7133; color: #2ecc71; }
    .badge-medium { background: #f1c40f33; color: #f1c40f; }
    .badge-high { background: #e74c3c33; color: #e74c3c; }

    /* レポート */
    .report-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }

    .report-tab {
      padding: 8px 16px;
      background: #1a1a2e;
      border: none;
      border-radius: 6px;
      color: #888;
      cursor: pointer;
      font-size: 14px;
    }

    .report-tab.active {
      background: #0f3460;
      color: #fff;
    }

    .report-content {
      display: none;
    }

    .report-content.active {
      display: block;
    }

    .report-item {
      background: #1a1a2e;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
    }

    .report-date {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 10px;
      color: #3498db;
    }

    .report-summary {
      color: #aaa;
      font-size: 14px;
      margin-bottom: 15px;
    }

    .report-section {
      margin-bottom: 15px;
    }

    .report-section h4 {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: #888;
      margin-bottom: 8px;
    }

    .report-section ul {
      list-style: none;
      padding-left: 20px;
    }

    .report-section li {
      font-size: 14px;
      margin-bottom: 4px;
      position: relative;
    }

    .report-section li::before {
      content: "•";
      position: absolute;
      left: -15px;
      color: #555;
    }

    .report-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 15px;
    }

    .report-stat {
      text-align: center;
      padding: 10px;
      background: #0f3460;
      border-radius: 6px;
    }

    .report-stat-value {
      font-size: 24px;
      font-weight: bold;
    }

    .report-stat-label {
      font-size: 12px;
      color: #888;
    }

    .report-finance {
      display: flex;
      justify-content: space-around;
      padding: 15px;
      background: #0f3460;
      border-radius: 6px;
    }

    .report-finance-item {
      text-align: center;
    }

    .report-finance-value {
      font-size: 20px;
      font-weight: bold;
    }

    .report-finance-label {
      font-size: 12px;
      color: #888;
    }

    /* スケジュールタスク */
    .scheduler-table {
      width: 100%;
      border-collapse: collapse;
    }

    .scheduler-table th,
    .scheduler-table td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid #333;
    }

    .scheduler-table th {
      color: #888;
      font-size: 12px;
      font-weight: normal;
    }

    .scheduler-table td {
      font-size: 14px;
    }

    .task-status-enabled {
      color: #2ecc71;
    }

    .task-status-disabled {
      color: #e74c3c;
    }

    .scheduler-update-time {
      font-size: 12px;
      color: #666;
      margin-bottom: 10px;
    }

    /* 通知設定 */
    .notification-setting-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid #333;
    }

    .notification-setting-item:last-child {
      border-bottom: none;
    }

    .notification-type-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .notification-type-icon {
      width: 24px;
      text-align: center;
    }

    .notification-type-name {
      font-weight: bold;
    }

    .notification-type-desc {
      font-size: 12px;
      color: #888;
    }

    .toggle-switch {
      position: relative;
      width: 50px;
      height: 26px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #555;
      transition: .3s;
      border-radius: 26px;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .3s;
      border-radius: 50%;
    }

    .toggle-switch input:checked + .toggle-slider {
      background-color: #2ecc71;
    }

    .toggle-switch input:checked + .toggle-slider:before {
      transform: translateX(24px);
    }

    /* 小サイズのトグルスイッチ */
    .toggle-switch.small {
      width: 40px;
      height: 22px;
    }

    .toggle-switch.small .toggle-slider:before {
      height: 16px;
      width: 16px;
      left: 3px;
      bottom: 3px;
    }

    .toggle-switch.small input:checked + .toggle-slider:before {
      transform: translateX(18px);
    }

    /* 通知カテゴリセクション */
    .notification-category-section {
      margin-bottom: 20px;
      border: 1px solid #333;
      border-radius: 8px;
      overflow: hidden;
    }

    .notification-category-header {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 15px;
      background: #2a2a2a;
      border-bottom: 1px solid #333;
    }

    .notification-category-icon {
      font-size: 18px;
    }

    .notification-category-name {
      font-weight: bold;
      font-size: 14px;
    }

    .notification-category-desc {
      font-size: 12px;
      color: #888;
      margin-left: auto;
    }

    .notification-items-list {
      padding: 5px 15px;
    }

    .notification-item-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #333;
    }

    .notification-item-row:last-child {
      border-bottom: none;
    }

    .notification-item-info {
      flex: 1;
    }

    .notification-item-name {
      font-weight: 500;
      font-size: 13px;
    }

    .notification-item-desc {
      font-size: 11px;
      color: #888;
      margin-top: 2px;
    }

    /* 通知履歴 */
    .notification-history-item {
      display: flex;
      gap: 10px;
      padding: 10px 0;
      border-bottom: 1px solid #333;
    }

    .notification-history-icon {
      width: 24px;
      text-align: center;
    }

    .notification-history-content {
      flex: 1;
    }

    .notification-history-title {
      font-weight: bold;
      font-size: 14px;
    }

    .notification-history-desc {
      font-size: 12px;
      color: #aaa;
    }

    .notification-history-meta {
      display: flex;
      gap: 10px;
      font-size: 11px;
      color: #666;
      margin-top: 4px;
    }

    .notification-sent {
      color: #2ecc71;
    }

    .notification-skipped {
      color: #f1c40f;
    }

    .notification-failed {
      color: #e74c3c;
    }

    /* フェーズ表示 */
    .phase-display {
      display: flex;
      align-items: flex-start;
      gap: 15px;
    }

    .phase-icon {
      font-size: 32px;
      line-height: 1;
    }

    .phase-info {
      flex: 1;
    }

    .phase-name {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .phase-description {
      color: #aaa;
      font-size: 14px;
      margin-bottom: 8px;
    }

    .phase-time {
      font-size: 12px;
      color: #666;
    }

    .phase-progress {
      margin-top: 10px;
      height: 4px;
      background: #333;
      border-radius: 2px;
      overflow: hidden;
    }

    .phase-progress-bar {
      height: 100%;
      background: #3498db;
      border-radius: 2px;
      transition: width 0.3s ease;
    }

    .phase-idle { color: #95a5a6; }
    .phase-planning { color: #9b59b6; }
    .phase-implementing { color: #3498db; }
    .phase-reviewing { color: #f1c40f; }
    .phase-analyzing { color: #1abc9c; }
    .phase-maintaining { color: #e67e22; }
    .phase-learning { color: #2ecc71; }

    .phase-goal {
      background: #0f3460;
      border-radius: 6px;
      padding: 10px 12px;
      margin-top: 12px;
    }

    .phase-goal-label {
      font-size: 11px;
      color: #888;
      margin-bottom: 4px;
    }

    .phase-goal-text {
      font-size: 14px;
      color: #3498db;
      font-weight: bold;
    }

    .phase-next-steps {
      margin-top: 12px;
    }

    .phase-next-steps-label {
      font-size: 11px;
      color: #888;
      margin-bottom: 6px;
    }

    .phase-next-steps-list {
      list-style: none;
    }

    .phase-next-steps-list li {
      font-size: 13px;
      color: #aaa;
      padding: 3px 0;
      padding-left: 16px;
      position: relative;
    }

    .phase-next-steps-list li::before {
      content: "→";
      position: absolute;
      left: 0;
      color: #666;
    }

    /* タスクフロー */
    .task-flow-section {
      margin-bottom: 15px;
    }

    .task-flow-section:last-child {
      margin-bottom: 0;
    }

    .task-flow-label {
      font-size: 12px;
      color: #888;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .task-flow-item {
      background: #1a1a2e;
      border-radius: 6px;
      padding: 10px 12px;
      margin-bottom: 8px;
    }

    .task-flow-item:last-child {
      margin-bottom: 0;
    }

    .task-flow-item.running {
      border-left: 3px solid #3498db;
      background: #1a1a2e;
    }

    .task-flow-item.next {
      border-left: 3px solid #2ecc71;
    }

    .task-flow-item.completed {
      border-left: 3px solid #555;
      opacity: 0.7;
    }

    .task-flow-name {
      font-weight: bold;
      font-size: 14px;
      margin-bottom: 4px;
    }

    .task-flow-time {
      font-size: 12px;
      color: #888;
    }

    .task-flow-empty {
      color: #666;
      font-size: 14px;
      text-align: center;
      padding: 10px;
    }

    /* 戦略概要 */
    .strategy-summary {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 15px;
    }

    .strategy-summary-item {
      text-align: center;
      padding: 10px;
      background: #0f3460;
      border-radius: 6px;
    }

    .strategy-summary-value {
      font-size: 20px;
      font-weight: bold;
    }

    .strategy-summary-label {
      font-size: 12px;
      color: #888;
    }

    .strategy-list {
      list-style: none;
      max-height: 250px;
      overflow-y: auto;
    }

    #strategyFullList .strategy-list {
      max-height: none;
      overflow-y: visible;
    }

    .strategy-item {
      background: #1a1a2e;
      border-radius: 6px;
      padding: 10px 12px;
      margin-bottom: 8px;
    }

    .strategy-item:last-child {
      margin-bottom: 0;
    }

    .strategy-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .strategy-name {
      font-weight: bold;
      font-size: 14px;
    }

    .strategy-status {
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
    }

    .strategy-status-active { background: #2ecc7133; color: #2ecc71; }
    .strategy-status-draft { background: #95a5a633; color: #95a5a6; }
    .strategy-status-paused { background: #f1c40f33; color: #f1c40f; }
    .strategy-status-pending { background: #3498db33; color: #3498db; }
    .strategy-status-completed { background: #9b59b633; color: #9b59b6; }
    .strategy-status-failed { background: #e74c3c33; color: #e74c3c; }

    .strategy-metrics {
      display: flex;
      gap: 15px;
      font-size: 12px;
      color: #888;
    }

    .strategy-roi.positive {
      color: #2ecc71;
    }

    .strategy-roi.negative {
      color: #e74c3c;
    }

    .strategy-empty {
      color: #666;
      font-size: 14px;
      text-align: center;
      padding: 20px;
    }

    /* 拒否理由モーダル */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal-content {
      background: #2d2d2d;
      padding: 24px;
      border-radius: 8px;
      max-width: 500px;
      width: 90%;
    }

    .modal-content h3 {
      margin-top: 0;
      color: #e74c3c;
    }

    .modal-content p {
      color: #aaa;
      margin-bottom: 12px;
    }

    .modal-content label {
      color: #888;
      font-size: 14px;
    }

    .modal-content textarea {
      width: 100%;
      min-height: 100px;
      margin: 12px 0;
      padding: 8px;
      background: #1a1a2e;
      border: 1px solid #444;
      border-radius: 4px;
      color: #eee;
      resize: vertical;
      box-sizing: border-box;
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      margin-top: 16px;
    }

    .btn-cancel {
      background: #555;
      color: #eee;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
    }

    .btn-cancel:hover {
      background: #666;
    }

    /* 戦略詳細タブ */
    .strategy-detail-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .strategy-detail-header h2 {
      margin: 0;
      font-size: 20px;
      color: #fff;
    }

    .strategy-detail-tabs {
      display: flex;
      gap: 0;
      margin-bottom: 20px;
      border-bottom: 1px solid #333;
    }

    .strategy-detail-tab {
      padding: 12px 24px;
      background: none;
      border: none;
      color: #888;
      cursor: pointer;
      font-size: 14px;
      border-bottom: 2px solid transparent;
      margin-bottom: -1px;
      transition: color 0.2s, border-color 0.2s;
    }

    .strategy-detail-tab:hover {
      color: #aaa;
    }

    .strategy-detail-tab.active {
      color: #3498db;
      border-bottom-color: #3498db;
    }

    .strategy-detail-body {
      min-height: 400px;
    }

    .strategy-section-content {
      display: none;
    }

    .strategy-section-content.active {
      display: block;
    }

    /* 戦略詳細コンテンツ */
    .strategy-detail-section {
      margin-bottom: 20px;
    }

    .strategy-detail-section h4 {
      font-size: 14px;
      color: #888;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .strategy-detail-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
    }

    .strategy-detail-item {
      background: #16213e;
      padding: 15px;
      border-radius: 8px;
    }

    .strategy-detail-label {
      font-size: 12px;
      color: #888;
      margin-bottom: 4px;
    }

    .strategy-detail-value {
      font-size: 18px;
      font-weight: bold;
    }

    .strategy-detail-value.positive {
      color: #2ecc71;
    }

    .strategy-detail-value.negative {
      color: #e74c3c;
    }

    .strategy-description {
      background: #16213e;
      padding: 15px;
      border-radius: 8px;
      font-size: 14px;
      line-height: 1.6;
      color: #aaa;
    }

    /* 実行ステップ */
    .execution-step {
      background: #16213e;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
      border-left: 4px solid #555;
    }

    .execution-step.success {
      border-left-color: #2ecc71;
    }

    .execution-step.failed {
      border-left-color: #e74c3c;
    }

    .execution-step.pending {
      border-left-color: #f1c40f;
    }

    .execution-step.running {
      border-left-color: #3498db;
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .execution-step-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .execution-step-name {
      font-weight: bold;
      font-size: 14px;
    }

    .execution-step-status {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
    }

    .step-status-success { background: #2ecc7133; color: #2ecc71; }
    .step-status-failed { background: #e74c3c33; color: #e74c3c; }
    .step-status-pending { background: #f1c40f33; color: #f1c40f; }
    .step-status-running { background: #3498db33; color: #3498db; }

    .execution-step-metrics {
      display: flex;
      gap: 15px;
      font-size: 12px;
      color: #888;
    }

    .execution-step-error {
      margin-top: 8px;
      padding: 8px;
      background: #e74c3c22;
      border-radius: 4px;
      font-size: 13px;
      color: #e74c3c;
    }

    /* 中間結果 */
    .intermediate-result {
      background: #16213e;
      border-radius: 8px;
      margin-bottom: 15px;
      overflow: hidden;
    }

    .intermediate-result-header {
      padding: 12px 15px;
      background: #0f3460;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .intermediate-result-title {
      font-weight: bold;
      font-size: 14px;
    }

    .intermediate-result-toggle {
      color: #888;
      transition: transform 0.2s;
    }

    .intermediate-result.expanded .intermediate-result-toggle {
      transform: rotate(180deg);
    }

    .intermediate-result-body {
      display: none;
      padding: 15px;
      font-size: 13px;
      line-height: 1.5;
      max-height: 300px;
      overflow-y: auto;
    }

    .intermediate-result.expanded .intermediate-result-body {
      display: block;
    }

    .intermediate-result-body pre {
      background: #1a1a2e;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
      white-space: pre-wrap;
      word-break: break-word;
    }

    /* 実行履歴 */
    .execution-history-item {
      background: #16213e;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
    }

    .execution-history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .execution-history-status {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .execution-history-time {
      font-size: 12px;
      color: #888;
    }

    .execution-history-summary {
      font-size: 13px;
      color: #aaa;
    }

    .execution-history-stats {
      display: flex;
      gap: 20px;
      margin-top: 10px;
      font-size: 12px;
    }

    .execution-history-stats span {
      color: #888;
    }

    .execution-history-empty {
      text-align: center;
      color: #666;
      padding: 30px;
    }

    /* クリック可能な戦略アイテム */
    .strategy-item.clickable {
      cursor: pointer;
      transition: background 0.2s, transform 0.1s;
    }

    .strategy-item.clickable:hover {
      background: #1f2a4a;
      transform: translateX(4px);
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>AutoClaudeKMP Dashboard</h1>
    <div class="status-indicator">
      <div class="status-dot" id="statusDot"></div>
      <span id="statusText">接続中...</span>
    </div>
  </div>

  <div class="tabs">
    <button class="tab active" onclick="switchTab('dashboard')">ダッシュボード</button>
    <button class="tab" onclick="switchTab('strategy-detail')" id="tabBtnStrategyDetail">戦略詳細</button>
    <button class="tab" onclick="switchTab('suggestions')">意見・提案</button>
    <button class="tab" onclick="switchTab('reports')">レポート</button>
    <button class="tab" onclick="switchTab('notifications')">通知設定</button>
  </div>

  <!-- ダッシュボードタブ -->
  <div id="tab-dashboard" class="tab-content active">
    <div class="grid">
      <div class="card">
        <h2>タスクフロー</h2>
        <div id="taskFlow">
          <div class="loading">タスクフローを取得中...</div>
        </div>
      </div>

      <div class="card">
        <h2>収益状況</h2>
        <div id="finance">
          <div class="stat">
            <span>今月の収入</span>
            <span class="stat-value positive" id="monthlyIncome">-</span>
          </div>
          <div class="stat">
            <span>今月の支出</span>
            <span class="stat-value negative" id="monthlyExpense">-</span>
          </div>
          <div class="stat">
            <span>純利益</span>
            <span class="stat-value" id="netProfit">-</span>
          </div>
          <div class="stat">
            <span>残り予算</span>
            <span class="stat-value" id="remainingBudget">-</span>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>承認待ちリクエスト</h2>
        <ul class="request-list" id="requestList">
          <li class="loading">リクエストを取得中...</li>
        </ul>
      </div>

      <div class="card">
        <h2>金稼ぎ戦略の概要</h2>
        <div id="strategyOverview">
          <div class="loading">戦略データを取得中...</div>
        </div>
      </div>

      <div class="card full-width">
        <h2>スケジュールタスク</h2>
        <div class="scheduler-update-time" id="schedulerUpdateTime">最終更新: 取得中...</div>
        <table class="scheduler-table">
          <thead>
            <tr>
              <th>タスク名</th>
              <th>次回実行</th>
              <th>最終実行</th>
              <th>間隔</th>
              <th>状態</th>
            </tr>
          </thead>
          <tbody id="schedulerTasks">
            <tr><td colspan="5" class="loading">タスクを取得中...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- 意見・提案タブ -->
  <div id="tab-suggestions" class="tab-content">
    <div class="suggestions-layout">
      <div class="card suggestion-form-card">
        <h2>提案を投稿</h2>
        <form class="suggestion-form" onsubmit="submitSuggestion(event)">
          <div class="form-group">
            <label for="suggestionTitle">タイトル</label>
            <input type="text" id="suggestionTitle" placeholder="タイトル" required>
          </div>
          <div class="form-group">
            <label for="suggestionContent">内容</label>
            <textarea id="suggestionContent" placeholder="詳細を記入" required></textarea>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="suggestionCategory">カテゴリ</label>
              <select id="suggestionCategory">
                <option value="feature">機能追加</option>
                <option value="improvement">改善</option>
                <option value="bug">バグ報告</option>
                <option value="question">質問</option>
                <option value="other">その他</option>
              </select>
            </div>
            <div class="form-group">
              <label for="suggestionPriority">優先度</label>
              <select id="suggestionPriority">
                <option value="low">低</option>
                <option value="medium" selected>中</option>
                <option value="high">高</option>
              </select>
            </div>
          </div>
          <button type="submit" class="btn-primary">送信</button>
        </form>
      </div>

      <div class="card suggestion-list-card">
        <h2>提案一覧</h2>
        <div class="suggestion-status-tabs" id="suggestionTabs">
          <div class="status-tab-buttons">
            <button class="status-tab-btn active" data-status="pending">未処理 <span class="tab-count" id="tabCountPending">0</span></button>
            <button class="status-tab-btn" data-status="accepted">採択 <span class="tab-count" id="tabCountAccepted">0</span></button>
            <button class="status-tab-btn" data-status="rejected">却下 <span class="tab-count" id="tabCountRejected">0</span></button>
            <button class="status-tab-btn" data-status="implemented">実装済 <span class="tab-count" id="tabCountImplemented">0</span></button>
            <button class="status-tab-btn" data-status="deferred">保留 <span class="tab-count" id="tabCountDeferred">0</span></button>
          </div>
          <div class="status-tab-content active" id="tabPending"></div>
          <div class="status-tab-content" id="tabAccepted"></div>
          <div class="status-tab-content" id="tabRejected"></div>
          <div class="status-tab-content" id="tabImplemented"></div>
          <div class="status-tab-content" id="tabDeferred"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- 通知設定タブ -->
  <div id="tab-notifications" class="tab-content">
    <div class="grid">
      <div class="card">
        <h2>Discord通知設定</h2>
        <div id="notificationSettings">
          <div class="loading">設定を取得中...</div>
        </div>
      </div>

      <div class="card">
        <h2>通知履歴</h2>
        <div id="notificationHistory" style="max-height: 400px; overflow-y: auto;">
          <div class="loading">履歴を取得中...</div>
        </div>
      </div>

      <div class="card">
        <h2>最近のアクティビティ</h2>
        <ul class="activity-list" id="activityList">
          <li class="loading">アクティビティを取得中...</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- 戦略詳細タブ -->
  <div id="tab-strategy-detail" class="tab-content">
    <!-- 一覧ビュー -->
    <div id="strategyListView" class="card full-width">
      <h2>金稼ぎ戦略一覧</h2>
      <div id="strategyFullList"></div>
    </div>

    <!-- 詳細ビュー -->
    <div id="strategyDetailView" class="card full-width" style="display: none;">
      <div class="strategy-detail-header">
        <h2 id="strategyDetailTitle">戦略詳細</h2>
        <button class="btn-secondary" onclick="showStrategyList()">一覧に戻る</button>
      </div>
      <div class="strategy-detail-tabs">
        <button class="strategy-detail-tab active" data-tab="overview" onclick="switchStrategySection('overview')">概要</button>
        <button class="strategy-detail-tab" data-tab="performance" onclick="switchStrategySection('performance')">パフォーマンス</button>
        <button class="strategy-detail-tab" data-tab="intermediate" onclick="switchStrategySection('intermediate')">中間結果</button>
        <button class="strategy-detail-tab" data-tab="steps" onclick="switchStrategySection('steps')">実行ステップ</button>
        <button class="strategy-detail-tab" data-tab="history" onclick="switchStrategySection('history')">実行履歴</button>
      </div>
      <div class="strategy-detail-body">
        <div id="strategySectionOverview" class="strategy-section-content active"></div>
        <div id="strategySectionPerformance" class="strategy-section-content"></div>
        <div id="strategySectionIntermediate" class="strategy-section-content"></div>
        <div id="strategySectionSteps" class="strategy-section-content"></div>
        <div id="strategySectionHistory" class="strategy-section-content"></div>
      </div>
    </div>
  </div>

  <!-- レポートタブ -->
  <div id="tab-reports" class="tab-content">
    <div class="card full-width">
      <h2>レポート</h2>
      <div class="report-tabs">
        <button class="report-tab active" onclick="switchReportTab('daily')">日報</button>
        <button class="report-tab" onclick="switchReportTab('weekly')">週報</button>
      </div>

      <div id="report-daily" class="report-content active">
        <div id="dailyReportList">
          <div class="loading">日報を取得中...</div>
        </div>
      </div>

      <div id="report-weekly" class="report-content">
        <div id="weeklyReportList">
          <div class="loading">週報を取得中...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- 拒否理由入力モーダル -->
  <div id="rejectModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <h3>リクエストを拒否</h3>
      <p id="rejectModalTitle"></p>
      <label for="rejectReason">拒否理由（任意）</label>
      <textarea id="rejectReason" placeholder="拒否理由を入力してください（省略可）"></textarea>
      <div class="modal-actions">
        <button class="btn-cancel" onclick="closeRejectModal()">キャンセル</button>
        <button class="btn-reject" onclick="confirmReject()">拒否する</button>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = '';

    // タブ切り替え
    function switchTab(tabName) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));

      document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
      document.getElementById(`tab-${tabName}`).classList.add('active');

      // データ再取得
      if (tabName === 'suggestions') {
        fetchSuggestions();
      } else if (tabName === 'reports') {
        fetchDailyReports();
        fetchWeeklyReports();
      } else if (tabName === 'notifications') {
        fetchNotificationSettings();
        fetchNotificationHistory();
        fetchActivity();
      } else if (tabName === 'strategy-detail') {
        fetchStrategyFullList();
      }
    }

    function switchReportTab(type) {
      document.querySelectorAll('.report-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.report-content').forEach(t => t.classList.remove('active'));

      document.querySelector(`.report-tab[onclick="switchReportTab('${type}')"]`).classList.add('active');
      document.getElementById(`report-${type}`).classList.add('active');
    }

    // WebSocket接続
    let ws;
    function connectWebSocket() {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      ws = new WebSocket(`${protocol}//${window.location.host}`);

      ws.onopen = () => {
        document.getElementById('statusDot').className = 'status-dot';
        document.getElementById('statusText').textContent = '稼働中';
      };

      ws.onclose = () => {
        document.getElementById('statusDot').className = 'status-dot error';
        document.getElementById('statusText').textContent = '切断';
        setTimeout(connectWebSocket, 5000);
      };

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        handleWebSocketMessage(data);
      };
    }

    function handleWebSocketMessage(data) {
      if (data.type === 'phase') {
        // タスクフローを更新（スケジューラーデータを再取得）
        fetchTaskFlow();
      } else if (data.type === 'finance') {
        fetchFinance();
      }
    }

    // データ取得
    async function fetchStatus() {
      try {
        const res = await fetch(`${API_BASE}/api/status`);
        const data = await res.json();
        updateStatus(data);
      } catch (error) {
        console.error('Failed to fetch status:', error);
      }
    }

    async function fetchFinance() {
      try {
        const res = await fetch(`${API_BASE}/api/finance`);
        const data = await res.json();
        updateFinance(data);
      } catch (error) {
        console.error('Failed to fetch finance:', error);
      }
    }

    async function fetchRequests() {
      try {
        const res = await fetch(`${API_BASE}/api/requests`);
        const data = await res.json();
        updateRequests(data);
      } catch (error) {
        console.error('Failed to fetch requests:', error);
      }
    }

    async function fetchTaskFlow() {
      try {
        const res = await fetch(`${API_BASE}/api/scheduler`);
        const data = await res.json();
        updateTaskFlow(data);
      } catch (error) {
        console.error('Failed to fetch task flow:', error);
      }
    }

    async function fetchActivity() {
      try {
        const res = await fetch(`${API_BASE}/api/activity`);
        const data = await res.json();
        updateActivity(data);
      } catch (error) {
        console.error('Failed to fetch activity:', error);
      }
    }

    async function fetchStrategies() {
      try {
        const res = await fetch(`${API_BASE}/api/strategies`);
        const data = await res.json();
        updateStrategyOverview(data);
      } catch (error) {
        console.error('Failed to fetch strategies:', error);
      }
    }

    async function fetchSuggestions() {
      try {
        const res = await fetch(`${API_BASE}/api/suggestions`);
        const data = await res.json();
        updateSuggestions(data);
      } catch (error) {
        console.error('Failed to fetch suggestions:', error);
      }
    }

    async function fetchDailyReports() {
      try {
        const res = await fetch(`${API_BASE}/api/reports/daily?limit=7`);
        const data = await res.json();
        updateDailyReports(data);
      } catch (error) {
        console.error('Failed to fetch daily reports:', error);
      }
    }

    async function fetchWeeklyReports() {
      try {
        const res = await fetch(`${API_BASE}/api/reports/weekly?limit=4`);
        const data = await res.json();
        updateWeeklyReports(data);
      } catch (error) {
        console.error('Failed to fetch weekly reports:', error);
      }
    }

    async function fetchSchedulerTasks() {
      try {
        const res = await fetch(`${API_BASE}/api/scheduler`);
        const data = await res.json();
        updateSchedulerTasks(data);
      } catch (error) {
        console.error('Failed to fetch scheduler tasks:', error);
      }
    }

    // 通知項目のメタデータをキャッシュ
    let notificationItemsMeta = null;
    let notificationCategories = null;

    async function fetchNotificationItemsMeta() {
      if (notificationItemsMeta) return;
      try {
        const res = await fetch(`${API_BASE}/api/notifications/items`);
        const data = await res.json();
        notificationItemsMeta = data.items;
        notificationCategories = data.categories;
      } catch (error) {
        console.error('Failed to fetch notification items meta:', error);
      }
    }

    async function fetchNotificationSettings() {
      try {
        // まず項目メタデータを取得
        await fetchNotificationItemsMeta();
        const res = await fetch(`${API_BASE}/api/notifications/settings`);
        const data = await res.json();
        updateNotificationSettings(data);
      } catch (error) {
        console.error('Failed to fetch notification settings:', error);
      }
    }

    async function fetchNotificationHistory() {
      try {
        const res = await fetch(`${API_BASE}/api/notifications/history`);
        const data = await res.json();
        updateNotificationHistory(data);
      } catch (error) {
        console.error('Failed to fetch notification history:', error);
      }
    }

    // UI更新
    function updateStatus(data) {
      const dot = document.getElementById('statusDot');
      const text = document.getElementById('statusText');

      if (data.state === 'healthy') {
        dot.className = 'status-dot';
        text.textContent = '稼働中';
      } else if (data.state === 'degraded') {
        dot.className = 'status-dot warning';
        text.textContent = '劣化';
      } else {
        dot.className = 'status-dot error';
        text.textContent = data.state;
      }
    }

    function updateFinance(data) {
      document.getElementById('monthlyIncome').textContent = `¥${data.monthlyIncome.toLocaleString()}`;
      document.getElementById('monthlyExpense').textContent = `¥${data.monthlyExpense.toLocaleString()}`;

      const netProfit = document.getElementById('netProfit');
      netProfit.textContent = `¥${data.netProfit.toLocaleString()}`;
      netProfit.className = data.netProfit >= 0 ? 'stat-value positive' : 'stat-value negative';

      document.getElementById('remainingBudget').textContent = `¥${data.remainingBudget.toLocaleString()}`;
    }

    function updateTaskFlow(schedulerData) {
      const container = document.getElementById('taskFlow');

      if (!schedulerData || !schedulerData.tasks || schedulerData.tasks.length === 0) {
        container.innerHTML = '<div class="task-flow-empty">スケジュールタスクがありません</div>';
        return;
      }

      const now = new Date();
      const tasks = schedulerData.tasks;

      // 有効なタスクのみフィルタ
      const enabledTasks = tasks.filter(t => t.enabled);

      // 次回実行タスク（時間順でソート）
      const upcomingTasks = enabledTasks
        .filter(t => t.nextRun && new Date(t.nextRun) > now)
        .sort((a, b) => new Date(a.nextRun) - new Date(b.nextRun))
        .slice(0, 3);

      // 直近実行タスク（最終実行時間でソート）
      const recentTasks = enabledTasks
        .filter(t => t.lastRun)
        .sort((a, b) => new Date(b.lastRun) - new Date(a.lastRun))
        .slice(0, 2);

      let html = '';

      // 次回実行セクション
      html += '<div class="task-flow-section">';
      html += '<div class="task-flow-label">⏰ 次回実行</div>';
      if (upcomingTasks.length > 0) {
        html += upcomingTasks.map(task => `
          <div class="task-flow-item next">
            <div class="task-flow-name">${escapeHtml(task.name)}</div>
            <div class="task-flow-time">${formatRelativeTime(task.nextRun)}</div>
          </div>
        `).join('');
      } else {
        html += '<div class="task-flow-empty">予定なし</div>';
      }
      html += '</div>';

      // 直近実行セクション
      html += '<div class="task-flow-section">';
      html += '<div class="task-flow-label">✓ 直近実行</div>';
      if (recentTasks.length > 0) {
        html += recentTasks.map(task => `
          <div class="task-flow-item completed">
            <div class="task-flow-name">${escapeHtml(task.name)}</div>
            <div class="task-flow-time">${formatRelativeTime(task.lastRun)}</div>
          </div>
        `).join('');
      } else {
        html += '<div class="task-flow-empty">実行履歴なし</div>';
      }
      html += '</div>';

      container.innerHTML = html;
    }

    function formatElapsedTime(startedAt) {
      if (!startedAt) return '不明';
      const start = new Date(startedAt);
      const now = new Date();
      const diffMs = now.getTime() - start.getTime();
      const diffSecs = Math.floor(diffMs / 1000);
      const diffMins = Math.floor(diffSecs / 60);
      const diffHours = Math.floor(diffMins / 60);

      if (diffHours > 0) {
        return `${diffHours}時間${diffMins % 60}分`;
      } else if (diffMins > 0) {
        return `${diffMins}分`;
      } else {
        return `${diffSecs}秒`;
      }
    }

    function updateRequests(requests) {
      const list = document.getElementById('requestList');

      if (requests.length === 0) {
        list.innerHTML = '<li class="loading">承認待ちのリクエストはありません</li>';
        return;
      }

      list.innerHTML = requests.map(req => `
        <li class="request-item">
          <div class="request-title">${escapeHtml(req.title)}</div>
          <div class="request-description">${escapeHtml(req.description)}</div>
          <div class="request-actions">
            <button class="btn-approve" onclick="approveRequest('${req.id}')">承認</button>
            <button class="btn-reject" onclick="rejectRequest('${req.id}', '${escapeHtml(req.title).replace(/'/g, "\\'")}')">拒否</button>
          </div>
        </li>
      `).join('');
    }

    function updateActivity(activities) {
      const list = document.getElementById('activityList');

      if (!activities || activities.length === 0) {
        list.innerHTML = '<li class="loading">アクティビティはありません</li>';
        return;
      }

      // 最新5件に制限
      const recentActivities = activities.slice(0, 5);

      list.innerHTML = recentActivities.map(activity => {
        const time = new Date(activity.timestamp);
        const timeStr = time.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
        const icon = activity.success ? '✓' : '✗';

        return `
          <li class="activity-item">
            <span class="activity-time">${timeStr}</span>
            <span class="activity-icon">${icon}</span>
            <span class="activity-text">${escapeHtml(activity.description || activity.actionType)}</span>
          </li>
        `;
      }).join('');
    }

    function updateStrategyOverview(strategies) {
      const container = document.getElementById('strategyOverview');

      if (!strategies || strategies.length === 0) {
        container.innerHTML = '<div class="strategy-empty">戦略はまだありません</div>';
        return;
      }

      // サマリー計算
      const activeStrategies = strategies.filter(s => s.status === 'active');
      const totalRevenue = strategies.reduce((sum, s) => sum + (s.metrics?.revenue || 0), 0);
      const avgRoi = strategies.length > 0
        ? strategies.reduce((sum, s) => sum + (s.metrics?.roi || 0), 0) / strategies.length
        : 0;

      let html = '';

      // サマリー部分
      html += `
        <div class="strategy-summary">
          <div class="strategy-summary-item">
            <div class="strategy-summary-value">${activeStrategies.length} / ${strategies.length}</div>
            <div class="strategy-summary-label">アクティブ戦略</div>
          </div>
          <div class="strategy-summary-item">
            <div class="strategy-summary-value ${totalRevenue >= 0 ? 'positive' : 'negative'}">¥${totalRevenue.toLocaleString()}</div>
            <div class="strategy-summary-label">総収益</div>
          </div>
          <div class="strategy-summary-item">
            <div class="strategy-summary-value ${avgRoi >= 0 ? 'positive' : 'negative'}">${avgRoi.toFixed(1)}%</div>
            <div class="strategy-summary-label">平均ROI</div>
          </div>
        </div>
      `;

      // 戦略リスト
      html += '<ul class="strategy-list">';
      html += strategies.map(strategy => {
        const perf = strategy.performance || {};
        const roi = perf.roi || 0;
        const roiClass = roi >= 0 ? 'positive' : 'negative';

        return `
          <li class="strategy-item clickable" onclick="openStrategyDetail('${strategy.id}')">
            <div class="strategy-header">
              <span class="strategy-name">${escapeHtml(strategy.name)}</span>
              <span class="strategy-status strategy-status-${strategy.status}">${getStrategyStatusLabel(strategy.status)}</span>
            </div>
            <div class="strategy-metrics">
              <span>収益: ¥${(perf.totalRevenue || 0).toLocaleString()}</span>
              <span>コスト: ¥${(perf.totalCost || 0).toLocaleString()}</span>
              <span class="strategy-roi ${roiClass}">ROI: ${roi.toFixed(1)}%</span>
              <span>実行: ${perf.executionCount || 0}回</span>
            </div>
          </li>
        `;
      }).join('');
      html += '</ul>';

      container.innerHTML = html;
    }

    function getStrategyStatusLabel(status) {
      const labels = {
        active: 'アクティブ',
        draft: '下書き',
        paused: '停止中',
        pending: '承認待ち',
        completed: '完了',
        failed: '失敗',
      };
      return labels[status] || status;
    }

    function updateSuggestions(suggestions) {
      // ステータス別にグループ化
      const byStatus = {
        pending: [],
        accepted: [],
        rejected: [],
        implemented: [],
        deferred: [],
      };

      if (suggestions && suggestions.length > 0) {
        suggestions.forEach(s => {
          const status = s.status || 'pending';
          if (byStatus[status]) {
            byStatus[status].push(s);
          } else {
            byStatus.pending.push(s);
          }
        });
      }

      // タブ形式の更新
      updateTabView(byStatus);
    }

    function updateTabView(byStatus) {
      const statuses = ['pending', 'accepted', 'rejected', 'implemented', 'deferred'];

      statuses.forEach(status => {
        const items = byStatus[status];
        const container = document.getElementById(`tab${capitalizeFirst(status)}`);
        const countEl = document.getElementById(`tabCount${capitalizeFirst(status)}`);

        if (countEl) countEl.textContent = items.length;

        if (!container) return;

        if (items.length === 0) {
          container.innerHTML = '<div class="kanban-empty">なし</div>';
          return;
        }

        container.innerHTML = items.map(s => renderSuggestionItem(s)).join('');
      });

      // タブ切り替えイベント
      document.querySelectorAll('.status-tab-btn').forEach(btn => {
        btn.onclick = () => {
          const status = btn.dataset.status;
          document.querySelectorAll('.status-tab-btn').forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.status-tab-content').forEach(c => c.classList.remove('active'));
          btn.classList.add('active');
          document.getElementById(`tab${capitalizeFirst(status)}`).classList.add('active');
        };
      });
    }

    function renderSuggestionItem(s) {
      const responseHtml = s.systemResponse ? `
        <div class="suggestion-response">
          <h4>システムの回答</h4>
          <p><strong>分析:</strong> ${escapeHtml(s.systemResponse.analysis)}</p>
          <p><strong>判断:</strong> ${escapeHtml(s.systemResponse.decision)}</p>
          ${s.systemResponse.actionPlan ? `<p><strong>アクションプラン:</strong> ${escapeHtml(s.systemResponse.actionPlan)}</p>` : ''}
        </div>
      ` : '';

      return `
        <div class="suggestion-item">
          <div class="suggestion-header">
            <div class="suggestion-header-left">
              <span class="suggestion-title">${escapeHtml(s.title)}</span>
            </div>
            <div class="suggestion-header-right">
              <span class="badge badge-${s.category}">${getCategoryLabel(s.category)}</span>
              <span class="badge badge-${s.priority}">${getPriorityLabel(s.priority)}</span>
              <span class="suggestion-status status-${s.status}">${getStatusLabel(s.status)}</span>
            </div>
          </div>
          <div class="suggestion-content">${escapeHtml(s.content)}</div>
          <div class="suggestion-meta">
            <span>${formatDate(s.createdAt)}</span>
          </div>
          ${responseHtml}
        </div>
      `;
    }

    function capitalizeFirst(str) {
      return str.charAt(0).toUpperCase() + str.slice(1);
    }

    function updateDailyReports(reports) {
      const container = document.getElementById('dailyReportList');

      if (!reports || reports.length === 0) {
        container.innerHTML = '<div class="loading">日報はまだありません</div>';
        return;
      }

      container.innerHTML = reports.map(report => `
        <div class="report-item">
          <div class="report-date">${report.date}</div>
          <div class="report-summary">${escapeHtml(report.summary)}</div>

          <div class="report-stats">
            <div class="report-stat">
              <div class="report-stat-value">${report.activities.tasksCompleted}</div>
              <div class="report-stat-label">完了タスク</div>
            </div>
            <div class="report-stat">
              <div class="report-stat-value">${report.activities.strategiesRun}</div>
              <div class="report-stat-label">戦略実行</div>
            </div>
            <div class="report-stat">
              <div class="report-stat-value">${report.activities.suggestionsProcessed}</div>
              <div class="report-stat-label">提案処理</div>
            </div>
          </div>

          ${report.accomplishments.length > 0 ? `
          <div class="report-section">
            <h4>✅ やったこと</h4>
            <ul>${report.accomplishments.map(a => `<li>${escapeHtml(a)}</li>`).join('')}</ul>
          </div>
          ` : ''}

          ${report.failures.length > 0 ? `
          <div class="report-section">
            <h4>❌ 失敗</h4>
            <ul>${report.failures.map(f => `<li>${escapeHtml(f)}</li>`).join('')}</ul>
          </div>
          ` : ''}

          ${report.improvements.length > 0 ? `
          <div class="report-section">
            <h4>📈 改善</h4>
            <ul>${report.improvements.map(i => `<li>${escapeHtml(i)}</li>`).join('')}</ul>
          </div>
          ` : ''}

          <div class="report-finance">
            <div class="report-finance-item">
              <div class="report-finance-value positive">¥${report.financials.income.toLocaleString()}</div>
              <div class="report-finance-label">収入</div>
            </div>
            <div class="report-finance-item">
              <div class="report-finance-value negative">¥${report.financials.expense.toLocaleString()}</div>
              <div class="report-finance-label">支出</div>
            </div>
            <div class="report-finance-item">
              <div class="report-finance-value ${report.financials.net >= 0 ? 'positive' : 'negative'}">¥${report.financials.net.toLocaleString()}</div>
              <div class="report-finance-label">収支</div>
            </div>
          </div>
        </div>
      `).join('');
    }

    function updateSchedulerTasks(data) {
      const tbody = document.getElementById('schedulerTasks');
      const updateTime = document.getElementById('schedulerUpdateTime');

      if (data.timestamp) {
        updateTime.textContent = `最終更新: ${formatRelativeTime(data.timestamp)}`;
      } else {
        updateTime.textContent = '最終更新: データなし';
      }

      if (!data.tasks || data.tasks.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="loading">スケジュールタスクはありません</td></tr>';
        return;
      }

      tbody.innerHTML = data.tasks.map(task => `
        <tr>
          <td>${escapeHtml(task.name)}</td>
          <td>${task.nextRun ? formatRelativeTime(task.nextRun) : '-'}</td>
          <td>${task.lastRun ? formatRelativeTime(task.lastRun) : '-'}</td>
          <td>${formatInterval(task.intervalMs, task.cronExpression)}</td>
          <td class="${task.enabled ? 'task-status-enabled' : 'task-status-disabled'}">
            ${task.enabled ? '✓ 有効' : '✗ 無効'}
          </td>
        </tr>
      `).join('');
    }

    function updateNotificationSettings(settings) {
      const container = document.getElementById('notificationSettings');

      // カテゴリアイコンのマッピング
      const categoryIcons = {
        info: '&#x2139;&#xFE0F;',
        success: '&#x2705;',
        warning: '&#x26A0;&#xFE0F;',
        error: '&#x274C;',
        critical: '&#x1F6A8;',
        audit: '&#x1F4CB;',
        suggestionResponse: '&#x1F4AC;',
      };

      // 通知項目をカテゴリごとにグループ化
      if (!notificationItemsMeta || !notificationCategories) {
        container.innerHTML = '<div class="loading">通知項目を読み込み中...</div>';
        return;
      }

      // カテゴリ順序
      const categoryOrder = ['info', 'success', 'warning', 'error', 'critical', 'suggestionResponse', 'audit'];

      // カテゴリごとに項目をグループ化
      const itemsByCategory = {};
      for (const cat of categoryOrder) {
        itemsByCategory[cat] = notificationItemsMeta.filter(item => item.category === cat);
      }

      let html = '';
      for (const cat of categoryOrder) {
        const items = itemsByCategory[cat];
        if (items.length === 0) continue;

        const catInfo = notificationCategories[cat];
        const catIcon = categoryIcons[cat];

        html += `
          <div class="notification-category-section">
            <div class="notification-category-header">
              <span class="notification-category-icon">${catIcon}</span>
              <span class="notification-category-name">${catInfo.name}</span>
              <span class="notification-category-desc">${catInfo.description}</span>
            </div>
            <div class="notification-items-list">
              ${items.map(item => {
                const isEnabled = settings.items && typeof settings.items[item.id] === 'boolean'
                  ? settings.items[item.id]
                  : item.defaultEnabled;
                return `
                  <div class="notification-item-row">
                    <div class="notification-item-info">
                      <div class="notification-item-name">${item.name}</div>
                      <div class="notification-item-desc">${item.description}</div>
                    </div>
                    <label class="toggle-switch small">
                      <input type="checkbox" ${isEnabled ? 'checked' : ''} onchange="updateNotificationItemSetting('${item.id}', this.checked)">
                      <span class="toggle-slider"></span>
                    </label>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        `;
      }

      container.innerHTML = html;
    }

    function updateNotificationHistory(history) {
      const container = document.getElementById('notificationHistory');

      if (!history || history.length === 0) {
        container.innerHTML = '<div class="loading">通知履歴はありません</div>';
        return;
      }

      const typeIcons = {
        info: '&#x2139;&#xFE0F;',
        success: '&#x2705;',
        warning: '&#x26A0;&#xFE0F;',
        error: '&#x274C;',
        critical: '&#x1F6A8;',
        audit: '&#x1F4CB;',
        suggestionResponse: '&#x1F4AC;',
      };

      container.innerHTML = history.map(item => `
        <div class="notification-history-item">
          <span class="notification-history-icon">${typeIcons[item.type] || ''}</span>
          <div class="notification-history-content">
            <div class="notification-history-title">${escapeHtml(item.title)}</div>
            ${item.description ? `<div class="notification-history-desc">${escapeHtml(item.description)}</div>` : ''}
            <div class="notification-history-meta">
              <span>${formatDate(item.timestamp)}</span>
              <span class="${item.sent ? 'notification-sent' : (item.reason ? 'notification-skipped' : 'notification-failed')}">
                ${item.sent ? '送信済み' : (item.reason || '失敗')}
              </span>
            </div>
          </div>
        </div>
      `).join('');
    }

    function updateWeeklyReports(reports) {
      const container = document.getElementById('weeklyReportList');

      if (!reports || reports.length === 0) {
        container.innerHTML = '<div class="loading">週報はまだありません</div>';
        return;
      }

      container.innerHTML = reports.map(report => `
        <div class="report-item">
          <div class="report-date">${report.week} (${report.startDate} - ${report.endDate})</div>
          <div class="report-summary">${escapeHtml(report.summary)}</div>

          <div class="report-stats">
            <div class="report-stat">
              <div class="report-stat-value">${report.totals.tasksCompleted}</div>
              <div class="report-stat-label">完了タスク</div>
            </div>
            <div class="report-stat">
              <div class="report-stat-value">${report.totals.strategiesRun}</div>
              <div class="report-stat-label">戦略実行</div>
            </div>
            <div class="report-stat">
              <div class="report-stat-value">${report.totals.suggestionsProcessed}</div>
              <div class="report-stat-label">提案処理</div>
            </div>
          </div>

          ${report.highlights.length > 0 ? `
          <div class="report-section">
            <h4>✨ ハイライト</h4>
            <ul>${report.highlights.map(h => `<li>${escapeHtml(h)}</li>`).join('')}</ul>
          </div>
          ` : ''}

          ${report.challenges.length > 0 ? `
          <div class="report-section">
            <h4>⚠️ 課題</h4>
            <ul>${report.challenges.map(c => `<li>${escapeHtml(c)}</li>`).join('')}</ul>
          </div>
          ` : ''}

          ${report.learnings.length > 0 ? `
          <div class="report-section">
            <h4>📚 学び</h4>
            <ul>${report.learnings.map(l => `<li>${escapeHtml(l)}</li>`).join('')}</ul>
          </div>
          ` : ''}

          <div class="report-finance">
            <div class="report-finance-item">
              <div class="report-finance-value positive">¥${report.totals.income.toLocaleString()}</div>
              <div class="report-finance-label">週間収入</div>
            </div>
            <div class="report-finance-item">
              <div class="report-finance-value negative">¥${report.totals.expense.toLocaleString()}</div>
              <div class="report-finance-label">週間支出</div>
            </div>
            <div class="report-finance-item">
              <div class="report-finance-value ${report.totals.net >= 0 ? 'positive' : 'negative'}">¥${report.totals.net.toLocaleString()}</div>
              <div class="report-finance-label">週間収支</div>
            </div>
          </div>
        </div>
      `).join('');
    }

    // アクション
    async function approveRequest(id) {
      try {
        await fetch(`${API_BASE}/api/requests/${id}/approve`, { method: 'POST' });
        fetchRequests();
      } catch (error) {
        console.error('Failed to approve:', error);
      }
    }

    let currentRejectId = null;

    function rejectRequest(id, title) {
      currentRejectId = id;
      document.getElementById('rejectModalTitle').textContent = title || 'このリクエストを拒否しますか？';
      document.getElementById('rejectReason').value = '';
      document.getElementById('rejectModal').style.display = 'flex';
    }

    function closeRejectModal() {
      document.getElementById('rejectModal').style.display = 'none';
      currentRejectId = null;
    }

    async function confirmReject() {
      if (!currentRejectId) return;

      const reason = document.getElementById('rejectReason').value.trim();

      try {
        await fetch(`${API_BASE}/api/requests/${currentRejectId}/reject`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ reason: reason || undefined }),
        });
        closeRejectModal();
        fetchRequests();
      } catch (error) {
        console.error('Failed to reject:', error);
        closeRejectModal();
      }
    }

    async function submitSuggestion(event) {
      event.preventDefault();

      const title = document.getElementById('suggestionTitle').value;
      const content = document.getElementById('suggestionContent').value;
      const category = document.getElementById('suggestionCategory').value;
      const priority = document.getElementById('suggestionPriority').value;

      try {
        const res = await fetch(`${API_BASE}/api/suggestions`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ title, content, category, priority }),
        });

        if (res.ok) {
          // フォームをリセット
          document.getElementById('suggestionTitle').value = '';
          document.getElementById('suggestionContent').value = '';
          document.getElementById('suggestionCategory').value = 'feature';
          document.getElementById('suggestionPriority').value = 'medium';

          // 提案一覧を更新
          fetchSuggestions();

          alert('提案が送信されました。次のハートビートで回答されます。');
        } else {
          alert('提案の送信に失敗しました。');
        }
      } catch (error) {
        console.error('Failed to submit suggestion:', error);
        alert('提案の送信に失敗しました。');
      }
    }

    async function updateNotificationSetting(type, enabled) {
      try {
        // 現在の設定を取得
        const res = await fetch(`${API_BASE}/api/notifications/settings`);
        const settings = await res.json();

        // 設定を更新
        settings.discord[type] = enabled;

        // 保存
        await fetch(`${API_BASE}/api/notifications/settings`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(settings),
        });
      } catch (error) {
        console.error('Failed to update notification setting:', error);
        alert('設定の更新に失敗しました。');
        // チェックボックスを元に戻す
        fetchNotificationSettings();
      }
    }

    async function updateNotificationItemSetting(itemId, enabled) {
      try {
        // 現在の設定を取得
        const res = await fetch(`${API_BASE}/api/notifications/settings`);
        const settings = await res.json();

        // items が存在しない場合は初期化
        if (!settings.items) {
          settings.items = {};
        }

        // 設定を更新
        settings.items[itemId] = enabled;

        // 保存
        await fetch(`${API_BASE}/api/notifications/settings`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(settings),
        });
      } catch (error) {
        console.error('Failed to update notification item setting:', error);
        alert('設定の更新に失敗しました。');
        // チェックボックスを元に戻す
        fetchNotificationSettings();
      }
    }

    // ユーティリティ
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatDate(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleDateString('ja-JP', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function getStatusLabel(status) {
      const labels = {
        pending: '未処理',
        reviewing: '検討中',
        accepted: '採択',
        rejected: '却下',
        implemented: '実装済',
        deferred: '保留',
      };
      return labels[status] || status;
    }

    function getCategoryLabel(category) {
      const labels = {
        feature: '機能追加',
        bug: 'バグ',
        improvement: '改善',
        question: '質問',
        other: 'その他',
      };
      return labels[category] || category;
    }

    function getPriorityLabel(priority) {
      const labels = {
        low: '低',
        medium: '中',
        high: '高',
      };
      return labels[priority] || priority;
    }

    function formatRelativeTime(dateStr) {
      const date = new Date(dateStr);
      const now = new Date();
      const diffMs = date.getTime() - now.getTime();
      const diffMins = Math.round(diffMs / 60000);
      const diffHours = Math.round(diffMs / 3600000);
      const diffDays = Math.round(diffMs / 86400000);

      if (diffMs > 0) {
        // 未来
        if (diffMins < 60) return `${diffMins}分後`;
        if (diffHours < 24) return `${diffHours}時間後`;
        if (diffDays === 1) return '明日';
        return `${diffDays}日後`;
      } else {
        // 過去
        const absMins = Math.abs(diffMins);
        const absHours = Math.abs(diffHours);
        const absDays = Math.abs(diffDays);
        if (absMins < 60) return `${absMins}分前`;
        if (absHours < 24) return `${absHours}時間前`;
        if (absDays === 1) return '昨日';
        return `${absDays}日前`;
      }
    }

    function formatInterval(intervalMs, cronExpression) {
      if (intervalMs) {
        const mins = Math.floor(intervalMs / 60000);
        const hours = Math.floor(mins / 60);
        if (hours > 0) return `${hours}時間ごと`;
        return `${mins}分ごと`;
      }
      if (cronExpression) {
        return cronExpression;
      }
      return '-';
    }

    // 戦略詳細タブ
    let currentStrategyDetail = null;

    async function openStrategyDetail(strategyId) {
      try {
        const res = await fetch(`${API_BASE}/api/strategies/${strategyId}`);
        if (!res.ok) {
          alert('戦略情報の取得に失敗しました');
          return;
        }
        const data = await res.json();
        currentStrategyDetail = data;

        // タブボタンを表示して切り替え
        document.getElementById('tabBtnStrategyDetail').style.display = 'inline-block';
        document.getElementById('strategyDetailTitle').textContent = data.name;

        // 戦略詳細タブに切り替え（まだそのタブにいない場合のみ）
        const currentTab = document.querySelector('.tab-content.active');
        if (!currentTab || currentTab.id !== 'tab-strategy-detail') {
          switchTab('strategy-detail');
        }

        // 詳細ビューを表示
        showStrategyDetail();

        // セクションを概要にリセット
        switchStrategySection('overview');
        renderStrategyDetail(data);
      } catch (error) {
        console.error('Failed to fetch strategy detail:', error);
        alert('戦略情報の取得に失敗しました');
      }
    }

    function showStrategyList() {
      // 一覧ビューを表示、詳細ビューを非表示
      document.getElementById('strategyListView').style.display = 'block';
      document.getElementById('strategyDetailView').style.display = 'none';
      currentStrategyDetail = null;
    }

    function showStrategyDetail() {
      // 詳細ビューを表示、一覧ビューを非表示
      document.getElementById('strategyListView').style.display = 'none';
      document.getElementById('strategyDetailView').style.display = 'block';
    }

    async function fetchStrategyFullList() {
      try {
        const res = await fetch(`${API_BASE}/api/strategies`);
        const strategies = await res.json();
        updateStrategyFullList(strategies);
      } catch (error) {
        console.error('Failed to fetch strategies:', error);
      }
    }

    function updateStrategyFullList(strategies) {
      const container = document.getElementById('strategyFullList');

      if (!strategies || strategies.length === 0) {
        container.innerHTML = '<div class="strategy-empty">戦略はまだありません</div>';
        return;
      }

      // サマリー計算
      const activeStrategies = strategies.filter(s => s.status === 'active');
      const totalRevenue = strategies.reduce((sum, s) => sum + (s.metrics?.revenue || 0), 0);
      const avgRoi = strategies.length > 0
        ? strategies.reduce((sum, s) => sum + (s.metrics?.roi || 0), 0) / strategies.length
        : 0;

      let html = '';

      // サマリー部分
      html += `
        <div class="strategy-summary">
          <div class="strategy-summary-item">
            <div class="strategy-summary-value">${activeStrategies.length} / ${strategies.length}</div>
            <div class="strategy-summary-label">アクティブ戦略</div>
          </div>
          <div class="strategy-summary-item">
            <div class="strategy-summary-value ${totalRevenue >= 0 ? 'positive' : 'negative'}">¥${totalRevenue.toLocaleString()}</div>
            <div class="strategy-summary-label">総収益</div>
          </div>
          <div class="strategy-summary-item">
            <div class="strategy-summary-value ${avgRoi >= 0 ? 'positive' : 'negative'}">${avgRoi.toFixed(1)}%</div>
            <div class="strategy-summary-label">平均ROI</div>
          </div>
        </div>
      `;

      // 戦略リスト
      html += '<ul class="strategy-list">';
      html += strategies.map(strategy => {
        const perf = strategy.performance || {};
        const roi = perf.roi || 0;
        const roiClass = roi >= 0 ? 'positive' : 'negative';

        return `
          <li class="strategy-item clickable" onclick="openStrategyDetail('${strategy.id}')">
            <div class="strategy-header">
              <span class="strategy-name">${escapeHtml(strategy.name)}</span>
              <span class="strategy-status strategy-status-${strategy.status}">${getStrategyStatusLabel(strategy.status)}</span>
            </div>
            <div class="strategy-metrics">
              <span>収益: ¥${(perf.totalRevenue || 0).toLocaleString()}</span>
              <span>コスト: ¥${(perf.totalCost || 0).toLocaleString()}</span>
              <span class="strategy-roi ${roiClass}">ROI: ${roi.toFixed(1)}%</span>
              <span>実行: ${perf.executionCount || 0}回</span>
            </div>
          </li>
        `;
      }).join('');
      html += '</ul>';

      container.innerHTML = html;
    }

    function switchStrategySection(sectionName) {
      document.querySelectorAll('.strategy-detail-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.strategy-section-content').forEach(t => t.classList.remove('active'));

      document.querySelector(`.strategy-detail-tab[data-tab="${sectionName}"]`).classList.add('active');
      document.getElementById(`strategySection${capitalizeFirst(sectionName)}`).classList.add('active');
    }

    function renderStrategyDetail(strategy) {
      renderOverviewSection(strategy);
      renderPerformanceSection(strategy);
      renderIntermediateSection(strategy);
      renderStepsSection(strategy);
      renderHistorySection(strategy);
    }

    function renderOverviewSection(strategy) {
      const container = document.getElementById('strategySectionOverview');
      const statusLabel = getStrategyStatusLabel(strategy.status);

      container.innerHTML = `
        <div class="strategy-detail-section">
          <h4>基本情報</h4>
          <div class="strategy-detail-grid">
            <div class="strategy-detail-item">
              <div class="strategy-detail-label">ステータス</div>
              <div class="strategy-detail-value"><span class="strategy-status strategy-status-${strategy.status}">${statusLabel}</span></div>
            </div>
            <div class="strategy-detail-item">
              <div class="strategy-detail-label">タイプ</div>
              <div class="strategy-detail-value">${getStrategyTypeLabel(strategy.type)}</div>
            </div>
            <div class="strategy-detail-item">
              <div class="strategy-detail-label">期待収益</div>
              <div class="strategy-detail-value">¥${(strategy.expectedRevenue || 0).toLocaleString()}/月</div>
            </div>
            <div class="strategy-detail-item">
              <div class="strategy-detail-label">リスクレベル</div>
              <div class="strategy-detail-value">${getRiskLevelLabel(strategy.riskLevel)}</div>
            </div>
          </div>
        </div>
        <div class="strategy-detail-section">
          <h4>説明</h4>
          <div class="strategy-description">${escapeHtml(strategy.description)}</div>
        </div>
        <div class="strategy-detail-section">
          <h4>日時</h4>
          <div class="strategy-detail-grid">
            <div class="strategy-detail-item">
              <div class="strategy-detail-label">作成日</div>
              <div class="strategy-detail-value" style="font-size: 14px;">${formatDate(strategy.createdAt)}</div>
            </div>
            ${strategy.activatedAt ? `
            <div class="strategy-detail-item">
              <div class="strategy-detail-label">アクティブ化</div>
              <div class="strategy-detail-value" style="font-size: 14px;">${formatDate(strategy.activatedAt)}</div>
            </div>
            ` : ''}
            ${strategy.performance?.lastExecutedAt ? `
            <div class="strategy-detail-item">
              <div class="strategy-detail-label">最終実行</div>
              <div class="strategy-detail-value" style="font-size: 14px;">${formatDate(strategy.performance.lastExecutedAt)}</div>
            </div>
            ` : ''}
          </div>
        </div>
      `;
    }

    function renderPerformanceSection(strategy) {
      const container = document.getElementById('strategySectionPerformance');
      const perf = strategy.performance || {};
      const roi = perf.roi || 0;
      const successRate = strategy.successRate || 0;
      const netProfit = (perf.totalRevenue || 0) - (perf.totalCost || 0);

      container.innerHTML = `
        <div class="strategy-detail-section">
          <h4>収益指標</h4>
          <div class="strategy-detail-grid">
            <div class="strategy-detail-item">
              <div class="strategy-detail-label">総収益</div>
              <div class="strategy-detail-value positive">¥${(perf.totalRevenue || 0).toLocaleString()}</div>
            </div>
            <div class="strategy-detail-item">
              <div class="strategy-detail-label">総コスト</div>
              <div class="strategy-detail-value negative">¥${(perf.totalCost || 0).toLocaleString()}</div>
            </div>
            <div class="strategy-detail-item">
              <div class="strategy-detail-label">純利益</div>
              <div class="strategy-detail-value ${netProfit >= 0 ? 'positive' : 'negative'}">¥${netProfit.toLocaleString()}</div>
            </div>
            <div class="strategy-detail-item">
              <div class="strategy-detail-label">ROI</div>
              <div class="strategy-detail-value ${roi >= 0 ? 'positive' : 'negative'}">${roi.toFixed(1)}%</div>
            </div>
          </div>
        </div>
        <div class="strategy-detail-section">
          <h4>実行統計</h4>
          <div class="strategy-detail-grid">
            <div class="strategy-detail-item">
              <div class="strategy-detail-label">実行回数</div>
              <div class="strategy-detail-value">${perf.executionCount || 0}回</div>
            </div>
            <div class="strategy-detail-item">
              <div class="strategy-detail-label">成功回数</div>
              <div class="strategy-detail-value positive">${perf.successCount || 0}回</div>
            </div>
            <div class="strategy-detail-item">
              <div class="strategy-detail-label">失敗回数</div>
              <div class="strategy-detail-value negative">${perf.failureCount || 0}回</div>
            </div>
            <div class="strategy-detail-item">
              <div class="strategy-detail-label">成功率</div>
              <div class="strategy-detail-value ${successRate >= 50 ? 'positive' : 'negative'}">${successRate.toFixed(1)}%</div>
            </div>
          </div>
        </div>
      `;
    }

    function renderIntermediateSection(strategy) {
      const container = document.getElementById('strategySectionIntermediate');
      const intermediate = strategy.intermediateResults || {};
      const keys = Object.keys(intermediate);

      if (keys.length === 0) {
        container.innerHTML = '<div class="execution-history-empty">中間結果はまだありません</div>';
        return;
      }

      container.innerHTML = keys.map(key => {
        const value = intermediate[key];
        const displayValue = typeof value === 'object' ? JSON.stringify(value, null, 2) : String(value);

        return `
          <div class="intermediate-result" onclick="toggleIntermediateResult(this)">
            <div class="intermediate-result-header">
              <span class="intermediate-result-title">${formatIntermediateKey(key)}</span>
              <span class="intermediate-result-toggle">&#9660;</span>
            </div>
            <div class="intermediate-result-body">
              <pre>${escapeHtml(displayValue)}</pre>
            </div>
          </div>
        `;
      }).join('');
    }

    function toggleIntermediateResult(element) {
      element.classList.toggle('expanded');
    }

    function formatIntermediateKey(key) {
      const labels = {
        marketResearch: '市場調査',
        productPlan: '商品計画',
        productContent: 'コンテンツ設計',
        listingDraft: '出品原稿',
        outline: 'アウトライン',
        draft: '下書き',
      };
      return labels[key] || key;
    }

    function renderStepsSection(strategy) {
      const container = document.getElementById('strategySectionSteps');
      const history = strategy.executionHistory || [];
      const latestExecution = history.length > 0 ? history[history.length - 1] : null;

      if (!latestExecution || !latestExecution.stepResults || latestExecution.stepResults.length === 0) {
        container.innerHTML = '<div class="execution-history-empty">実行ステップデータがありません</div>';
        return;
      }

      container.innerHTML = latestExecution.stepResults.map((step, index) => {
        const statusClass = step.success ? 'success' : (step.error === '承認待ち' ? 'pending' : 'failed');
        const statusLabel = step.success ? '成功' : (step.error === '承認待ち' ? '待機中' : '失敗');

        return `
          <div class="execution-step ${statusClass}">
            <div class="execution-step-header">
              <span class="execution-step-name">${step.stepId || `ステップ ${index + 1}`}</span>
              <span class="execution-step-status step-status-${statusClass}">${statusLabel}</span>
            </div>
            <div class="execution-step-metrics">
              <span>収益: ¥${(step.revenue || 0).toLocaleString()}</span>
              <span>コスト: ¥${(step.cost || 0).toLocaleString()}</span>
            </div>
            ${step.error && step.error !== '承認待ち' ? `
            <div class="execution-step-error">エラー: ${escapeHtml(step.error)}</div>
            ` : ''}
          </div>
        `;
      }).join('');
    }

    function renderHistorySection(strategy) {
      const container = document.getElementById('strategySectionHistory');
      const history = strategy.executionHistory || [];

      if (history.length === 0) {
        container.innerHTML = '<div class="execution-history-empty">実行履歴はまだありません</div>';
        return;
      }

      // 新しい順にソート
      const sortedHistory = [...history].reverse();

      container.innerHTML = sortedHistory.map((exec, index) => {
        const statusClass = exec.success ? 'success' : 'failed';
        const statusIcon = exec.success ? '&#x2705;' : '&#x274C;';
        const stepCount = exec.stepResults?.length || 0;
        const successSteps = exec.stepResults?.filter(s => s.success).length || 0;

        return `
          <div class="execution-history-item">
            <div class="execution-history-header">
              <div class="execution-history-status">
                <span>${statusIcon}</span>
                <span style="font-weight: bold; color: ${exec.success ? '#2ecc71' : '#e74c3c'};">${exec.success ? '成功' : '失敗'}</span>
              </div>
              <span class="execution-history-time">#${history.length - index}</span>
            </div>
            <div class="execution-history-summary">${escapeHtml(exec.summary || '')}</div>
            <div class="execution-history-stats">
              <span>ステップ: ${successSteps}/${stepCount}</span>
              <span>収益: <span class="positive">¥${(exec.totalRevenue || 0).toLocaleString()}</span></span>
              <span>コスト: <span class="negative">¥${(exec.totalCost || 0).toLocaleString()}</span></span>
            </div>
          </div>
        `;
      }).join('');
    }

    function getStrategyTypeLabel(type) {
      const labels = {
        affiliate: 'アフィリエイト',
        freelance: 'フリーランス',
        digital_product: 'デジタルプロダクト',
        content_creation: 'コンテンツ制作',
        other: 'その他',
      };
      return labels[type] || type;
    }

    function getRiskLevelLabel(level) {
      const labels = {
        0: '低',
        1: '中',
        2: '高',
        3: '重大',
      };
      return labels[level] || level;
    }

    // 初期化
    connectWebSocket();
    fetchStatus();
    fetchTaskFlow();
    fetchFinance();
    fetchRequests();
    fetchStrategies();
    fetchSchedulerTasks();

    // 定期更新
    setInterval(fetchStatus, 30000);
    setInterval(fetchTaskFlow, 30000);
    setInterval(fetchFinance, 60000);
    setInterval(fetchRequests, 30000);
    setInterval(fetchStrategies, 60000);
    setInterval(fetchSchedulerTasks, 60000);
  </script>
</body>
</html>
